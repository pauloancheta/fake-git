#!/usr/bin/env ruby

require "fake/git"
require "optparse"

# Parse options
$OPTIONS = Hash.new
OptionParser.new do |opts|
  opts.set_banner "Welcome to FakeGit"
  opts.on("--stdin", "Get output from stdin") do
    $OPTIONS[:stdin] = true
  end

  opts.on("-w", "Introduce writeable") do
    $OPTIONS[:stdin] = true
  end

  opts.on("-s", "silence -s from catfile") { $OPTIONS[:cat_file_size] = true }
  opts.on("-p", "silence -s from catfile") { $OPTIONS[:cat_file_print] = true }
  opts.on("-t", "silence -s from catfile") { $OPTIONS[:cat_file_type] = true }
end.parse!

# begin exe

cmd, _ = ARGV
if cmd.nil? || !$OPTIONS[:stdin]
  Fake::Git.call(ARGV)
  return
end

# with stdin
while input = STDIN.gets
  input.each_line do |line|
    begin
      full_cmd = [cmd, line].flatten

      Fake::Git.call( full_cmd )
    rescue Errno::EPIPE
      exit(74)
    end
  end
end
